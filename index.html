<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Prueba de Three JS</title>
  <script type="text/javascript" src="js/three.js"></script>
  <script type="text/javascript" src="js/OBJMTLLoader.js"></script>
  <script type="text/javascript" src="js/OBJLoader.js"></script>
  <script  type="text/javascript" src="js/DDSLoader.js"></script>
  <script  type="text/javascript" src="js/MTLLoader.js"></script>
  
  <script type="text/javascript" src="js/stands.js"></script>

  <script type="text/javascript" src="engine.js"></script>
  <script type="text/javascript" src="character_controller.js"></script>
  <!--
  <script type="text/javascript" src="http://chandlerprall.github.io/Physijs/physi.js"></script>
  <script type="text/javascript" src="http://chandlerprall.github.io/Physijs/examples/js/stats.js"></script>S
  <script type="text/javascript" src="physijs_worker.js"></script>
  <script type="text/javascript" src="ammo.js"></script>
  -->

  <script id="vertexShader" type="x-shader/x-vertex">
  varying vec2 vUv;
  void main() {
    vUv = uv;
    gl_Position = projectionMatrix *
          modelViewMatrix * vec4(position, 1.0 );
  }
</script>

<script id="fragmentShader" type="x-shader/x-fragment">
  precision highp float;
  varying vec2 vUv;
  uniform sampler2D colTex;
  uniform sampler2D shadTex;
  void main(void) {
    gl_FragColor = texture2D(colTex, vUv) * texture2D(shadTex, vUv);
  }
</script>

</head>
<body>
<h1>Prueba de Three JS</h1>
<div id="renderDiv"></div>

<p>
<span id="loadingSpan" style="display:inline;">Cargando Stands...</span>
<span id="loadedSpan" style="display:none;">
  <a href="javascript:addStand01();">Stand01</a>
  <a href="javascript:addStand02();">Stand02</a>
</span>
</p>
<p>Distancia: <span id="distanceSpan"></span></p>
</body>
<script type="text/javascript">

  Engine.init({container: renderDiv, fps: 15});
  var scene = Engine.scene;
  var camera = Engine.camera;

  var light = new THREE.AmbientLight(0xffffff);

  scene.add(light);

  var clock = new THREE.Clock();

  var boxGeom = new THREE.BoxGeometry(0.5,1.6,0.5);
  var boxMat = new THREE.MeshBasicMaterial({color:0x0000ff});
  var cube = new THREE.Mesh(boxGeom, boxMat);
  cube.position.y = 0.8;
  cube.position.x = 10;
  cube.position.z = 10;

  var stand01;
  var stand02;
  var pabellon;
  var velocidadDesplazamiento = 0.3;
  var loaded = false

  // cargar pabellon 
  var loader = new THREE.OBJMTLLoader();
  loader.load( 'fachada/fachada.obj', 'fachada/fachada.mtl', function ( object ) {

    //object.position.y = -80;
    pabellon = object;
    pabellon.scale.x = 0.024;
    pabellon.scale.y = 0.024;
    pabellon.scale.z = 0.024;
    scene.add( pabellon );

  }, onProgress, onError );
  //--------------------------------------------------------------------------------
 
  LoadStand("stand01.js", "textures/diff01.png",
            "textures/occ01.png", function (obj) {
    stand01 = obj;
    setLoaded();
  });

  LoadStand("stand02.js", "textures/diff02.png",
            "textures/occ02.png", function (obj) {
    stand02 = obj;
    setLoaded();
  });


  var rotPos = 0;
  var camDist = 5;
 


  addCube();

  var center = {x:0, y:1, z:0};
  var tecla = {};
  var antX = 300;
  var antY = 0;
  var mouseKeep = false;
  var moveY, clickX;

  // eventos raton

  var caster = new THREE.Raycaster();
  var ray = new THREE.Vector3();
  var collidables = [stand02];
  var collisions;
  var pause = false;

  var arrow = new THREE.ArrowHelper(ray, new THREE.Vector3(0,0,0), 10);
  scene.add(arrow);

  var controller = new CharacterController({mesh: cube, cam: camera, velocity: 3, distance: 4});
       
  function render(delta) {
    //eventosKey();

    controller.updatePosition(delta);
    controller.updateMouse();
    controller.updateCamera();

    ray.x = Math.sin(cube.rotation.y);
    ray.z = Math.cos(cube.rotation.y);

    caster.set(cube.position, ray);
    arrow.setDirection(ray);
    arrow.position.x = cube.position.x;
    arrow.position.z = cube.position.z;
    arrow.position.y = cube.position.y;

    if (pabellon) {
      collisions = caster.intersectObject(pabellon, true);
      if (collisions.length > 0) {
        distanceSpan.textContent = collisions[0].distance;
      } else {
        distanceSpan.textContent = "NULL";
      }
    }
  }

  Engine.update = render;
  Engine.start();

</script>
</html>